# ReviewAgent 設計

本設計は、VibeFlow におけるリファクタリング成果物に対して自動レビューを行う **ReviewAgent** の設計です。`diff` ファイルと `result.json` を元に、AI ベースのコメントを Pull Request に投稿し、必要に応じて自動マージまたは人間へのエスカレーションを行います。

---

## 1. レビュー項目チェックリスト

以下のチェック項目に従って `diff` と `result.json` を解析します。

| 項目カテゴリ         | チェック内容                                               | ソース                      | 判定方式               |
| -------------------- | ---------------------------------------------------------- | --------------------------- | ---------------------- |
| ビルド成功性         | `result.json` に `buildStatus: success` が記録されているか | result.json                 | 静的判定               |
| テスト網羅性         | テストカバレッジが変更前より低下していないか               | result.json.coverage        | 差分比較               |
| 機能破壊             | 変更後のテスト失敗がないか                                 | result.json.tests           | 静的判定               |
| スタイル遵守         | Linter 警告・エラーが新規に追加されていないか              | result.json.lint            | 差分分析               |
| セマンティック一致   | 関数名変更／削除が意図的か（推定）                         | diff + rule-based NLP       | AI                     |
| 責務逸脱             | 既存のドメイン境界を越えた変更がないか                     | domain-map.json + diff      | 境界比較               |
| コメント漏れ         | 公開関数に JSDoc コメントがあるか                          | diff                        | AST 検査               |
| 循環依存             | モジュール間依存に循環がないか                             | result.json.dependencyGraph | トポロジカル判定       |
| 意味不明な命名       | 意味を持たない識別子 (a, temp, data2 など)                 | diff                        | LLM-based NLP          |
| 大規模変更の理由不明 | 変更行数が多く、意図の記述がない                           | diff + PR description       | LLM ヒューリスティクス |

---

## 2. コメントフォーマット（Markdown テンプレ）

````markdown
### 🚨 ReviewAgent Feedback

#### File: `{{filePath}}`

#### Lines: {{startLine}}–{{endLine}}

> ⚠️ **{{title}}**

{{description}}

---

🛠 **Suggestion**:

```ts
{
  {
    suggestedCode;
  }
}
```
````

✍️ Rationale: {{reasoning}}

---

👀 This review was auto-generated by ReviewAgent. Please verify before merging.

````

---

## 3. 自動マージ判定基準

以下の全条件を満たす場合に自動マージ可能と判定します。

- `result.json.buildStatus === "success"`
- `result.json.tests.failed.length === 0`
- `coverage.after >= coverage.before`
- `lint.newIssues.length === 0`
- **重大なコメント（Severity: High）が存在しない**
- Pull Request に「Auto-merge: true」タグが付与されている

> **備考**: 重大なコメントは以下のいずれかに該当する場合：
> - 責務逸脱
> - 循環依存
> - テストでのエラー
> - Lint 重大違反（Security, Type Error）

---

## 4. エスカレーションルール（人間レビュアーとの役割分担）

| ケース                                   | 対応                   | コメントにフラグ付け                           |
|------------------------------------------|------------------------|-----------------------------------------------|
| ビルド or テスト失敗                     | エスカレーション        | `<!-- human-review: build/test failure -->`   |
| セマンティック差分が大きい場合           | 人間に要確認依頼        | `<!-- human-review: semantic diff -->`        |
| 命名の曖昧さ／責務逸脱など判断が揺れるケース | 参考意見として提示（マージ不可） | `<!-- human-review: ambiguous -->`            |
| すべて問題なし                           | 自動承認                | `<!-- auto-reviewed: pass -->`                |

人間レビュアーには以下のようなダッシュボード通知が送られます：

```json
{
  "pr": 123,
  "status": "needs-human-review",
  "reason": ["semantic diff", "circular dependency"],
  "files": ["src/usecases/price.ts", "src/domain/ledger.ts"]
}
```

---

## 5. TDD向けテストケース一覧

### 🎯 ユニットテスト

| 対象モジュール        | テスト項目                                                                 |
|---------------------|--------------------------------------------------------------------------|
| `DiffAnalyzer`      | 差分抽出の精度、関数・構文・コメントなどの構造抽出精度                     |
| `CoverageComparer`  | before/after カバレッジの差分検出と閾値処理                                 |
| `RuleEngine`        | セマンティック一致・責務逸脱・命名曖昧さの検出、境界違反の妥当性判定         |
| `CommentFormatter`  | Markdownテンプレートへの挿入、生成コメントの体裁検査                         |
| `AutoMergeEvaluator`| 自動マージ条件の全項目に対する静的評価（PRタグ・ビルド・Lintなど）         |
| `EscalationRouter`  | 条件に応じた正しいルール分岐とコメント挿入判定の適合性                       |

### 🔁 統合テスト

- `diff + result.json` を与えて、重大なコメント／軽微なコメントの分類が正しく行われるか
- `domain-map.json` に基づいて責務逸脱が正しく検出されるか（明示的な逆流パターン含む）
- `AutoMergeEvaluator` が条件一致時のみ `<!-- auto-reviewed: pass -->` を返すか
- `semantic diff` と `circular dependency` が検出された場合に human-review トリガーが付与されるか

### 📎 モック戦略

- `diff`, `result.json`, `domain-map.json` はスナップショット JSON を fixture として保持
- LLM/NLP系の検出は出力ログを snapshot 比較し、意図的エラー入力に対する反応を検証
- コメント投稿部分は抽象化し、内容のみで検証（GitHub連携は除外）

---
